# .github/workflows/flutter_build.yml
name: Build Buyer & Merchant APK (release)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.x"
          channel: "stable"
          cache: true

      # مسیرها را به‌صورت مقاوم کشف می‌کنیم (buyer/merchant با نام‌های مختلف)
      - name: Detect app directories
        id: detect
        shell: bash
        run: |
          set -e
          # کاندیداهای ممکن برای نام پوشه‌ها
          CANDS_BUYER="buyer buyer-app buyer_app buyer-apps/buyer buyer_app/buyer"
          CANDS_MERCH="merchant merchant-app merchant_app merchant-apps/merchant merchant_app/merchant"

          find_pubspec () {
            for d in $1; do
              if [ -f "$d/pubspec.yaml" ]; then
                echo "$d"
                return 0
              fi
            done
            echo ""
            return 0
          }

          BUYER_DIR=$(find_pubspec "$CANDS_BUYER")
          MERCH_DIR=$(find_pubspec "$CANDS_MERCH")

          # اگر فقط در ریشه pubspec داشتیم
          [ -z "$BUYER_DIR" ] && [ -f pubspec.yaml ] && BUYER_DIR="."
          [ -z "$MERCH_DIR" ] && [ -f pubspec.yaml ] && MERCH_DIR="."

          if [ -z "$BUYER_DIR" ]; then
            echo "❌ pubspec.yaml for BUYER not found"; exit 1
          fi
          if [ -z "$MERCH_DIR" ]; then
            echo "❌ pubspec.yaml for MERCHANT not found"; exit 1
          fi

          echo "BUYER_DIR=$BUYER_DIR"   >> $GITHUB_OUTPUT
          echo "MERCH_DIR=$MERCH_DIR"   >> $GITHUB_OUTPUT
          echo "✅ Buyer: $BUYER_DIR | Merchant: $MERCH_DIR"

      # تابع کمکی برای هر اپ: pub get → ایجاد اسکفولد اندروید در صورت حذف بودن → بیلد
      - name: Build BUYER APK (release)
        working-directory: ${{ steps.detect.outputs.BUYER_DIR }}
        run: |
          flutter pub get
          # اگر فولدر android حذف شده، فقط اندروید را بساز
          [ -d android ] || flutter create --platforms=android .
          flutter build apk --release

      - name: Upload BUYER APK
        uses: actions/upload-artifact@v4
        with:
          name: buyer-apk
          path: ${{ steps.detect.outputs.BUYER_DIR }}/build/app/outputs/flutter-apk/app-release.apk

      - name: Build MERCHANT APK (release)
        working-directory: ${{ steps.detect.outputs.MERCH_DIR }}
        run: |
          flutter pub get
          [ -d android ] || flutter create --platforms=android .
          flutter build apk --release

      - name: Upload MERCHANT APK
        uses: actions/upload-artifact@v4
        with:
          name: merchant-apk
          path: ${{ steps.detect.outputs.MERCH_DIR }}/build/app/outputs/flutter-apk/app-release.apk
